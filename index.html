<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rétroplanning Pro - Vue Agenda</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #1e293b;
            --border: #cbd5e1;
            --danger: #ef4444;
            --weekend-bg: #f8fafc;
            --today-bg: #fefce8;
            --forced: #7c3aed;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }

        header {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .project-header-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .field-group { display: flex; flex-direction: column; gap: 0.4rem; }
        label { font-weight: 600; font-size: 0.85rem; color: var(--secondary); }
        input { padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; }
        
        .checkbox-group { flex-direction: row; align-items: center; gap: 0.75rem; cursor: pointer; }

        /* --- Task Form --- */
        .task-form {
            background: var(--card-bg);
            padding: 1.2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            align-items: end;
            border: 1px solid var(--border);
        }

        .task-form .btn-primary { grid-column: span 1; height: 42px; }

        /* --- Agenda / Calendar --- */
        .calendar-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid var(--border);
        }

        .cal-day-label {
            background: #f8fafc;
            padding: 0.5rem;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .cal-cell {
            min-height: 100px;
            background: white;
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 0.3rem;
            position: relative;
        }

        .cal-cell.weekend { background-color: var(--weekend-bg); color: #94a3b8; }
        .cal-cell.other-month { opacity: 0.3; }
        
        .day-number { font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; display: block; }

        .task-chip {
            font-size: 0.65rem;
            background: var(--primary);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-chip.forced { background: var(--forced); }
        .task-chip.deadline { background: var(--danger); font-weight: bold; }

        /* --- Table --- */
        .table-container {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 1rem; text-align: left; border-bottom: 2px solid var(--border); font-size: 0.9rem; }
        td { padding: 1rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; }

        .date-forced { border-bottom: 2px solid var(--forced); color: var(--forced); font-weight: 600; }

        .btn {
            cursor: pointer; padding: 0.6rem 1.2rem; border-radius: 6px; border: none; font-weight: 600;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #fee2e2; color: var(--danger); }

        @media print {
            .no-print { display: none !important; }
            body { padding: 0; background: white; }
            .container { max-width: 100%; }
            .cal-cell { min-height: 80px; }
            @page { size: A4 landscape; margin: 1cm; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div style="display: flex; justify-content: space-between;">
            <h1 style="margin:0; color: var(--primary);">Rétroplanning Agenda</h1>
            <div class="no-print">
                <button class="btn btn-danger" style="background:#f1f5f9; color:#64748b" onclick="resetProject()">Tout effacer</button>
                <button class="btn btn-primary" onclick="window.print()">Imprimer l'Agenda</button>
            </div>
        </div>

        <div class="project-header-grid">
            <div class="field-group">
                <label>Nom du Projet</label>
                <input type="text" id="projectName" placeholder="Nom du projet..." oninput="saveAndCalc()">
            </div>
            <div class="field-group">
                <label>Date de Livraison Finale</label>
                <input type="date" id="deadline" onchange="saveAndCalc()">
            </div>
            <div class="field-group checkbox-group">
                <input type="checkbox" id="workDaysOnly" onchange="saveAndCalc()" checked>
                <label for="workDaysOnly">Jours ouvrés uniquement</label>
            </div>
        </div>
    </header>

    <div class="no-print task-form">
        <div class="field-group">
            <label>Tâche</label>
            <input type="text" id="newTaskName" placeholder="Ex: Revue de code">
        </div>
        <div class="field-group">
            <label>Durée (j)</label>
            <input type="number" id="newTaskDuration" value="1" min="1">
        </div>
        <div class="field-group">
            <label>Tampon (j)</label>
            <input type="number" id="newTaskBuffer" value="0" min="0">
        </div>
        <div class="field-group">
            <label>Début (Optionnel)</label>
            <input type="date" id="newTaskStartFixed">
        </div>
        <div class="field-group">
            <label>Fin (Optionnel)</label>
            <input type="date" id="newTaskEndFixed">
        </div>
        <button class="btn btn-primary" onclick="addTask()">Ajouter</button>
    </div>

    <div class="calendar-container">
        <div class="calendar-header">
            <h3 id="calendarMonth" style="margin:0">Mois</h3>
            <div class="no-print">
                <button class="btn" onclick="changeMonth(-1)">« Précédent</button>
                <button class="btn" onclick="changeMonth(1)">Suivant »</button>
            </div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Tâche</th>
                    <th>Durée + Tampon</th>
                    <th>Début prévu</th>
                    <th>Fin prévue</th>
                    <th class="no-print">Action</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>
    </div>
</div>

<script>
    let project = {
        name: "",
        deadline: "",
        workDaysOnly: true,
        tasks: []
    };

    let viewDate = new Date();

    function isWeekend(date) {
        const d = date.getDay();
        return d === 0 || d === 6;
    }

    function addDays(date, days, workOnly) {
        let d = new Date(date);
        let count = 0;
        let step = days >= 0 ? 1 : -1;
        let absDays = Math.abs(days);

        if (absDays === 0) return d;

        while (count < absDays) {
            d.setDate(d.getDate() + step);
            if (workOnly) {
                if (!isWeekend(d)) count++;
            } else {
                count++;
            }
        }
        return d;
    }

    function saveAndCalc() {
        project.name = document.getElementById('projectName').value;
        project.deadline = document.getElementById('deadline').value;
        project.workDaysOnly = document.getElementById('workDaysOnly').checked;

        if (project.deadline) {
            let currentEnd = new Date(project.deadline);
            currentEnd.setHours(12,0,0,0);

            // Calcul rétro-actif
            // On parcourt les tâches de la plus récente à la plus ancienne (ordre inverse du tableau)
            for (let i = 0; i < project.tasks.length; i++) {
                let t = project.tasks[i];
                let totalDays = (parseFloat(t.duration) || 1) + (parseFloat(t.buffer) || 0);

                if (t.endFixed) {
                    // Si fin forcée
                    t.endDate = new Date(t.endFixed);
                    t.endDate.setHours(12,0,0,0);
                    t.startDate = addDays(t.endDate, -(totalDays - 1), project.workDaysOnly);
                } else if (t.startFixed) {
                    // Si début forcé
                    t.startDate = new Date(t.startFixed);
                    t.startDate.setHours(12,0,0,0);
                    t.endDate = addDays(t.startDate, (totalDays - 1), project.workDaysOnly);
                } else {
                    // Rétroplanning automatique
                    t.endDate = new Date(currentEnd);
                    t.startDate = addDays(t.endDate, -(totalDays - 1), project.workDaysOnly);
                }
                
                // On met à jour la date pivot pour la tâche précédente (plus tôt dans le temps)
                // seulement si on est en mode auto pour ne pas décaler le flux
                if (!t.startFixed && !t.endFixed) {
                    currentEnd = addDays(t.startDate, -1, project.workDaysOnly);
                } else {
                    // Si une tâche est fixe, on considère que la précédente finit la veille de son début
                    currentEnd = addDays(t.startDate, -1, project.workDaysOnly);
                }
            }
        }

        localStorage.setItem('retro_agenda_data_v2', JSON.stringify(project));
        render();
    }

    function addTask() {
        const name = document.getElementById('newTaskName').value;
        const dur = document.getElementById('newTaskDuration').value;
        const buf = document.getElementById('newTaskBuffer').value;
        const startFixed = document.getElementById('newTaskStartFixed').value;
        const endFixed = document.getElementById('newTaskEndFixed').value;
        
        if(!name) return;

        project.tasks.unshift({ 
            name, 
            duration: dur, 
            buffer: buf,
            startFixed: startFixed || null,
            endFixed: endFixed || null
        });

        // Reset form
        document.getElementById('newTaskName').value = "";
        document.getElementById('newTaskStartFixed').value = "";
        document.getElementById('newTaskEndFixed').value = "";
        
        saveAndCalc();
    }

    function removeTask(index) {
        project.tasks.splice(index, 1);
        saveAndCalc();
    }

    function changeMonth(offset) {
        viewDate.setMonth(viewDate.getMonth() + offset);
        render();
    }

    function render() {
        const tbody = document.getElementById('taskBody');
        tbody.innerHTML = '';
        project.tasks.forEach((t, i) => {
            const startStyle = t.startFixed ? 'class="date-forced"' : '';
            const endStyle = t.endFixed ? 'class="date-forced"' : '';
            
            const row = `<tr>
                <td>${t.name} ${t.startFixed || t.endFixed ? '<small style="color:var(--forced)">(Fixe)</small>' : ''}</td>
                <td>${t.duration}j ${t.buffer > 0 ? '+'+t.buffer+'j' : ''}</td>
                <td><span ${startStyle}>${t.startDate ? t.startDate.toLocaleDateString() : '-'}</span></td>
                <td><span ${endStyle}>${t.endDate ? t.endDate.toLocaleDateString() : '-'}</span></td>
                <td class="no-print"><button class="btn btn-danger" onclick="removeTask(${i})">×</button></td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        renderCalendar();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthLabel = document.getElementById('calendarMonth');
        grid.innerHTML = '';

        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        monthLabel.innerText = new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(viewDate);

        ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(d => {
            grid.insertAdjacentHTML('beforeend', `<div class="cal-day-label">${d}</div>`);
        });

        const firstDay = new Date(year, month, 1);
        let startOffset = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

        const calStart = new Date(firstDay);
        calStart.setDate(calStart.getDate() - startOffset);

        for (let i = 0; i < 42; i++) {
            const current = new Date(calStart);
            current.setDate(current.getDate() + i);
            current.setHours(12,0,0,0);

            const isCurrentMonth = current.getMonth() === month;
            const isWk = isWeekend(current);
            const dateStr = current.toDateString();

            let cellHtml = `<div class="cal-cell ${isWk ? 'weekend' : ''} ${!isCurrentMonth ? 'other-month' : ''}">
                <span class="day-number">${current.getDate()}</span>
                <div class="cell-content"></div>
            </div>`;
            grid.insertAdjacentHTML('beforeend', cellHtml);

            const cellContent = grid.lastChild.querySelector('.cell-content');

            if (project.deadline && new Date(project.deadline).toDateString() === dateStr) {
                cellContent.insertAdjacentHTML('beforeend', `<div class="task-chip deadline">LIVRAISON</div>`);
            }

            project.tasks.forEach(t => {
                if (t.startDate && t.endDate) {
                    if (current >= t.startDate && current <= t.endDate) {
                        const isForced = t.startFixed || t.endFixed ? 'forced' : '';
                        cellContent.insertAdjacentHTML('beforeend', `<div class="task-chip ${isForced}">${t.name}</div>`);
                    }
                }
            });
        }
    }

    function resetProject() {
        if(confirm("Supprimer tout le projet ?")) {
            project.tasks = [];
            project.name = "";
            project.deadline = "";
            document.getElementById('projectName').value = "";
            document.getElementById('deadline').value = "";
            saveAndCalc();
        }
    }

    window.onload = () => {
        const saved = localStorage.getItem('retro_agenda_data_v2');
        if (saved) {
            project = JSON.parse(saved);
            // Re-convertir les dates stockées en objets Date
            project.tasks.forEach(t => {
                if(t.startDate) t.startDate = new Date(t.startDate);
                if(t.endDate) t.endDate = new Date(t.endDate);
            });
            document.getElementById('projectName').value = project.name || "";
            document.getElementById('deadline').value = project.deadline || "";
            document.getElementById('workDaysOnly').checked = project.workDaysOnly;
        }
        saveAndCalc();
    };
</script>

</body>
</html>
