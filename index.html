
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©troplanning - Planification √† rebours</title>
    <style>
        /* ========== VARIABLES & RESET ========== */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
            min-height: 100vh;
        }
        /* ========== LAYOUT ========== */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        /* ========== LIVE CLOCK HEADER ========== */
        .live-clock-bar {
            background: var(--gray-800);
            color: white;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .live-clock {
            font-weight: 600;
            font-size: 16px;
            font-variant-numeric: tabular-nums;
        }
        .live-date {
            color: var(--gray-300);
        }
        /* ========== HEADER ========== */
        .header {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 28px;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header h1 .icon {
            font-size: 32px;
        }
        .project-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        /* ========== BUTTONS ========== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }
        .btn-secondary:hover {
            background: var(--gray-300);
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover {
            background: #15803d;
        }
        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
        }
        .btn-icon {
            padding: 8px;
            min-width: 36px;
            justify-content: center;
        }
        /* ========== FORMS ========== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-600);
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .form-group input.error {
            border-color: var(--danger);
        }
        .toggle-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--gray-300);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toggle.active {
            background: var(--primary);
        }
        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: var(--shadow);
        }
        .toggle.active::after {
            transform: translateX(22px);
        }
        .toggle-label {
            font-size: 14px;
            color: var(--gray-600);
        }
        /* ========== CARDS ========== */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* ========== TASK TABLE ========== */
        .tasks-container {
            overflow-x: auto;
        }
        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .tasks-table th {
            background: var(--gray-50);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-600);
            border-bottom: 2px solid var(--gray-200);
            white-space: nowrap;
        }
        .tasks-table td {
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
        }
        .tasks-table tr:hover {
            background: var(--gray-50);
        }
        .tasks-table tr.dragging {
            opacity: 0.5;
            background: var(--primary);
        }
        .tasks-table tr.drag-over {
            border-top: 2px solid var(--primary);
        }
        .task-name {
            font-weight: 500;
            color: var(--gray-800);
        }
        .task-dates {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .task-date {
            font-size: 13px;
            color: var(--gray-600);
        }
        .task-date.start {
            color: var(--success);
        }
        .task-date.end {
            color: var(--primary);
        }
        .task-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-blocking {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-buffer {
            background: #dbeafe;
            color: #1e40af;
        }
        .task-actions {
            display: flex;
            gap: 4px;
        }
        .drag-handle {
            cursor: grab;
            color: var(--gray-400);
            padding: 4px;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .order-buttons {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .order-btn {
            padding: 2px 6px;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            line-height: 1;
        }
        .order-btn:hover {
            background: var(--gray-200);
        }
        /* ========== GANTT CHART ========== */
        .gantt-container {
            overflow-x: auto;
            padding: 20px 0;
        }
        .gantt-chart {
            min-width: 100%;
            position: relative;
        }
        .gantt-header {
            display: flex;
            border-bottom: 2px solid var(--gray-300);
            margin-bottom: 10px;
            padding-bottom: 8px;
        }
        .gantt-label-col {
            min-width: 200px;
            flex-shrink: 0;
            font-weight: 600;
            color: var(--gray-600);
            padding-right: 16px;
        }
        .gantt-timeline {
            display: flex;
            flex: 1;
            position: relative;
        }
        .gantt-day {
            min-width: 40px;
            text-align: center;
            font-size: 10px;
            color: var(--gray-500);
            border-left: 1px solid var(--gray-200);
            padding: 4px 2px;
        }
        .gantt-day.weekend {
            background: #fef2f2;
            color: var(--danger);
        }
        .gantt-day.today {
            background: #dbeafe;
            font-weight: 700;
        }
        .gantt-row {
            display: flex;
            align-items: center;
            min-height: 36px;
            border-bottom: 1px solid var(--gray-100);
        }
        .gantt-row-label {
            min-width: 200px;
            flex-shrink: 0;
            font-size: 13px;
            color: var(--gray-700);
            padding-right: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .gantt-row-bars {
            display: flex;
            flex: 1;
            position: relative;
            height: 28px;
        }
        .gantt-bar {
            position: absolute;
            height: 24px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 500;
            box-shadow: var(--shadow);
            top: 2px;
        }
        .gantt-bar.has-buffer {
            background: linear-gradient(135deg, var(--primary), var(--warning));
        }
        .gantt-grid-col {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 40px;
            border-left: 1px solid var(--gray-100);
        }
        .gantt-grid-col.weekend {
            background: rgba(254, 242, 242, 0.5);
        }
        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-500);
        }
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .empty-state p {
            font-size: 16px;
        }
        /* ========== ALERTS ========== */
        .alert {
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            font-size: 14px;
        }
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        /* ========== MODAL ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.2s;
        }
        .modal-overlay.active .modal {
            transform: scale(1);
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .app-container {
                padding: 12px;
            }
            .header h1 {
                font-size: 22px;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .tasks-table {
                font-size: 12px;
            }
            .tasks-table th,
            .tasks-table td {
                padding: 8px 6px;
            }
            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }
            .gantt-label-col,
            .gantt-row-label {
                min-width: 120px;
            }
            .gantt-day {
                min-width: 30px;
                font-size: 9px;
            }
            .live-clock-bar {
                flex-direction: column;
                gap: 4px;
                text-align: center;
            }
        }
        /* ========== PRINT STYLES ========== */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body {
                background: white;
                font-size: 11pt;
            }
            .live-clock-bar,
            .no-print,
            .btn,
            .task-actions,
            .order-buttons,
            .drag-handle,
            .modal-overlay,
            #taskForm,
            .project-actions {
                display: none !important;
            }
            .app-container {
                max-width: 100%;
                padding: 0;
            }
            .header,
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
                margin-bottom: 15px;
            }
            .print-header {
                display: block !important;
                border-bottom: 2px solid #333;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            .print-header h1 {
                font-size: 24pt;
                margin-bottom: 5px;
            }
            .print-header .print-meta {
                display: flex;
                justify-content: space-between;
                font-size: 10pt;
                color: #666;
            }
            .tasks-table {
                font-size: 10pt;
            }
            .tasks-table th {
                background: #f0f0f0 !important;
            }
            .tasks-table tr {
                page-break-inside: avoid;
            }
            .gantt-container {
                page-break-before: always;
            }
            .gantt-bar {
                background: #333 !important;
                color: white !important;
            }
            .gantt-day.weekend {
                background: #f5f5f5 !important;
            }
            .task-badge {
                border: 1px solid #999;
            }
            @page {
                size: A4 landscape;
                margin: 15mm;
            }
        }
        .print-header {
            display: none;
        }
        /* ========== ANIMATIONS ========== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Barre horloge en temps r√©el -->
    <div class="live-clock-bar">
        <div class="live-date" id="liveDate"></div>
        <div class="live-clock" id="liveClock"></div>
    </div>
    <div class="app-container">
        <!-- En-t√™te pour impression -->
        <div class="print-header">
            <h1 id="printProjectName">R√©troplanning</h1>
            <div class="print-meta">
                <span>Date de livraison : <strong id="printDeadline"></strong></span>
                <span>√âdit√© le : <strong id="printDate"></strong></span>
            </div>
        </div>
        <!-- Header du projet -->
        <header class="header">
            <div class="header-top">
                <h1>
                    <span class="icon">üìÖ</span>
                    <span>R√©troplanning</span>
                </h1>
                <div class="project-actions no-print">
                    <button class="btn btn-success" onclick="recalculate()">
                        üîÑ Recalculer
                    </button>
                    <button class="btn btn-primary" onclick="printPlanning()">
                        üñ®Ô∏è Imprimer
                    </button>
                    <button class="btn btn-danger" onclick="confirmReset()">
                        üóëÔ∏è R√©initialiser
                    </button>
                </div>
            </div>
            <div class="form-grid no-print">
                <div class="form-group">
                    <label for="projectName">Nom du projet</label>
                    <input type="text" id="projectName" placeholder="Mon projet" onchange="saveProject()">
                </div>
                <div class="form-group">
                    <label for="deadline">Date de livraison (deadline)</label>
                    <input type="date" id="deadline" onchange="saveProject(); recalculate();">
                </div>
                <div class="form-group">
                    <label for="hoursPerDay">Heures par jour</label>
                    <input type="number" id="hoursPerDay" value="8" min="1" max="24" onchange="saveProject()">
                </div>
                <div class="form-group">
                    <label>Jours ouvr√©s uniquement (Lun-Ven)</label>
                    <div class="toggle-group">
                        <div class="toggle" id="workdaysToggle" onclick="toggleWorkdays()"></div>
                        <span class="toggle-label" id="workdaysLabel">Non</span>
                    </div>
                </div>
            </div>
        </header>
        <!-- Formulaire d'ajout de t√¢che -->
        <div class="card no-print" id="taskForm">
            <h2 class="card-title">‚ûï Ajouter une t√¢che</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="taskName">Nom de la t√¢che *</label>
                    <input type="text" id="taskName" placeholder="Ex: D√©veloppement">
                </div>
                <div class="form-group">
                    <label for="taskDuration">Dur√©e (jours) *</label>
                    <input type="number" id="taskDuration" value="1" min="0.5" step="0.5">
                </div>
                <div class="form-group">
                    <label for="taskBuffer">Tampon / Buffer (jours)</label>
                    <input type="number" id="taskBuffer" value="0" min="0" step="0.5">
                </div>
                <div class="form-group">
                    <label>Options</label>
                    <div class="toggle-group">
                        <input type="checkbox" id="taskBlocking">
                        <label for="taskBlocking" style="font-weight: normal;">T√¢che bloquante</label>
                    </div>
                </div>
            </div>
            <div class="form-group" style="margin-top: 12px;">
                <label for="taskNotes">Notes (facultatif)</label>
                <textarea id="taskNotes" rows="2" placeholder="D√©tails suppl√©mentaires..."></textarea>
            </div>
            <div style="margin-top: 16px;">
                <button class="btn btn-primary" onclick="addTask()">
                    ‚ûï Ajouter la t√¢che
                </button>
            </div>
        </div>
        <!-- Alerte si deadline d√©pass√©e -->
        <div class="alert alert-warning" id="alertPast" style="display: none;">
            ‚ö†Ô∏è Attention : certaines t√¢ches commencent dans le pass√© ! Ajustez la deadline ou r√©duisez la dur√©e des t√¢ches.
        </div>
        <!-- Tableau des t√¢ches -->
        <div class="card">
            <h2 class="card-title">üìã Liste des t√¢ches</h2>
            <div class="tasks-container">
                <table class="tasks-table" id="tasksTable">
                    <thead>
                        <tr>
                            <th class="no-print" style="width: 40px;"></th>
                            <th style="width: 30px;">#</th>
                            <th>T√¢che</th>
                            <th style="width: 80px;">Dur√©e</th>
                            <th style="width: 80px;">Tampon</th>
                            <th style="width: 100px;">D√©but</th>
                            <th style="width: 100px;">Fin</th>
                            <th style="width: 100px;">Options</th>
                            <th class="no-print" style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tasksBody">
                    </tbody>
                </table>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="icon">üìù</div>
                    <p>Aucune t√¢che pour le moment.<br>Ajoutez votre premi√®re t√¢che ci-dessus.</p>
                </div>
            </div>
        </div>
        <!-- Diagramme de Gantt -->
        <div class="card">
            <h2 class="card-title">üìä Aper√ßu Gantt</h2>
            <div class="gantt-container" id="ganttContainer">
                <div class="gantt-chart" id="ganttChart">
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de confirmation -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <h3 class="modal-title">‚ö†Ô∏è Confirmer la r√©initialisation</h3>
            <p>√ätes-vous s√ªr de vouloir supprimer toutes les t√¢ches et r√©initialiser le projet ? Cette action est irr√©versible.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn btn-danger" onclick="resetProject()">R√©initialiser</button>
            </div>
        </div>
    </div>
    <!-- Modal d'√©dition de t√¢che -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h3 class="modal-title">‚úèÔ∏è Modifier la t√¢che</h3>
            <input type="hidden" id="editTaskId">
            <div class="form-group">
                <label for="editTaskName">Nom de la t√¢che</label>
                <input type="text" id="editTaskName">
            </div>
            <div class="form-grid" style="margin-top: 12px;">
                <div class="form-group">
                    <label for="editTaskDuration">Dur√©e (jours)</label>
                    <input type="number" id="editTaskDuration" min="0.5" step="0.5">
                </div>
                <div class="form-group">
                    <label for="editTaskBuffer">Tampon (jours)</label>
                    <input type="number" id="editTaskBuffer" min="0" step="0.5">
                </div>
            </div>
            <div class="form-group" style="margin-top: 12px;">
                <div class="toggle-group">
                    <input type="checkbox" id="editTaskBlocking">
                    <label for="editTaskBlocking" style="font-weight: normal;">T√¢che bloquante</label>
                </div>
            </div>
            <div class="form-group" style="margin-top: 12px;">
                <label for="editTaskNotes">Notes</label>
                <textarea id="editTaskNotes" rows="2"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveTaskEdit()">Enregistrer</button>
            </div>
        </div>
    </div>
    <script>
        // ==========================================
        // √âTAT DE L'APPLICATION
        // ==========================================
        let project = {
            name: 'Mon Projet',
            deadline: '',
            workdaysOnly: true,
            hoursPerDay: 8,
            tasks: []
        };
        // ==========================================
        // HORLOGE EN TEMPS R√âEL
        // ==========================================
        function updateClock() {
            const now = new Date();
            
            // Format de l'heure
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('liveClock').textContent = now.toLocaleTimeString('fr-FR', timeOptions);
            
            // Format de la date
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = now.toLocaleDateString('fr-FR', dateOptions);
            document.getElementById('liveDate').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
        }
        // Mettre √† jour toutes les secondes
        setInterval(updateClock, 1000);
        updateClock();
        // ==========================================
        // GESTION DES DATES
        // ==========================================
        
        /**
         * Cr√©e une date √† midi pour √©viter les probl√®mes de fuseau horaire
         */
        function createDate(dateStr) {
            if (!dateStr) return null;
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day, 12, 0, 0);
        }
        /**
         * Formate une date en string YYYY-MM-DD
         */
        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        /**
         * Formate une date en fran√ßais
         */
        function formatDateFR(date) {
            if (!date) return '-';
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            return date.toLocaleDateString('fr-FR', options);
        }
        /**
         * V√©rifie si une date est un weekend
         */
        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // Dimanche = 0, Samedi = 6
        }
        /**
         * Soustrait des jours ouvr√©s ou calendaires
         */
        function subtractDays(date, days, workdaysOnly) {
            const result = new Date(date);
            let remaining = days;
            
            while (remaining > 0) {
                result.setDate(result.getDate() - 1);
                if (workdaysOnly && isWeekend(result)) {
                    continue; // Ne pas compter les weekends
                }
                remaining--;
            }
            
            // Si on tombe sur un weekend et qu'on veut jours ouvr√©s, reculer encore
            if (workdaysOnly) {
                while (isWeekend(result)) {
                    result.setDate(result.getDate() - 1);
                }
            }
            
            return result;
        }
        /**
         * Calcule le nombre de jours entre deux dates
         */
        function daysBetween(start, end) {
            const msPerDay = 24 * 60 * 60 * 1000;
            return Math.round((end - start) / msPerDay);
        }
        // ==========================================
        // CALCUL DU R√âTROPLANNING
        // ==========================================
        
        function recalculate() {
            if (!project.deadline || project.tasks.length === 0) {
                renderTasks();
                renderGantt();
                return;
            }
            const deadline = createDate(project.deadline);
            let currentEnd = new Date(deadline);
            let hasPastDates = false;
            const today = new Date();
            today.setHours(12, 0, 0, 0);
            // Parcourir les t√¢ches de la derni√®re √† la premi√®re (r√©troplanning)
            for (let i = project.tasks.length - 1; i >= 0; i--) {
                const task = project.tasks[i];
                const totalDuration = task.duration + (task.buffer || 0);
                
                // Date de fin = currentEnd
                task.endDate = new Date(currentEnd);
                
                // Date de d√©but = endDate - dur√©e totale
                task.startDate = subtractDays(task.endDate, Math.ceil(totalDuration) - 1, project.workdaysOnly);
                
                // V√©rifier si dans le pass√©
                if (task.startDate < today) {
                    hasPastDates = true;
                }
                
                // Prochaine t√¢che commence avant celle-ci
                currentEnd = subtractDays(task.startDate, 1, project.workdaysOnly);
            }
            // Afficher alerte si dates dans le pass√©
            document.getElementById('alertPast').style.display = hasPastDates ? 'block' : 'none';
            saveProject();
            renderTasks();
            renderGantt();
        }
        // ==========================================
        // GESTION DES T√ÇCHES
        // ==========================================
        
        function addTask() {
            const name = document.getElementById('taskName').value.trim();
            const duration = parseFloat(document.getElementById('taskDuration').value);
            const buffer = parseFloat(document.getElementById('taskBuffer').value) || 0;
            const blocking = document.getElementById('taskBlocking').checked;
            const notes = document.getElementById('taskNotes').value.trim();
            // Validation
            if (!name) {
                document.getElementById('taskName').classList.add('error');
                alert('Veuillez entrer un nom de t√¢che');
                return;
            }
            if (!duration || duration <= 0) {
                document.getElementById('taskDuration').classList.add('error');
                alert('Veuillez entrer une dur√©e valide');
                return;
            }
            // Nettoyer les erreurs
            document.getElementById('taskName').classList.remove('error');
            document.getElementById('taskDuration').classList.remove('error');
            // Cr√©er la t√¢che
            const task = {
                id: Date.now(),
                name,
                duration,
                buffer,
                blocking,
                notes,
                startDate: null,
                endDate: null
            };
            project.tasks.push(task);
            
            // R√©initialiser le formulaire
            document.getElementById('taskName').value = '';
            document.getElementById('taskDuration').value = '1';
            document.getElementById('taskBuffer').value = '0';
            document.getElementById('taskBlocking').checked = false;
            document.getElementById('taskNotes').value = '';
            recalculate();
        }
        function deleteTask(id) {
            if (confirm('Supprimer cette t√¢che ?')) {
                project.tasks = project.tasks.filter(t => t.id !== id);
                recalculate();
            }
        }
        function moveTask(id, direction) {
            const index = project.tasks.findIndex(t => t.id === id);
            if (index === -1) return;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= project.tasks.length) return;
            // √âchanger les positions
            [project.tasks[index], project.tasks[newIndex]] = [project.tasks[newIndex], project.tasks[index]];
            recalculate();
        }
        function editTask(id) {
            const task = project.tasks.find(t => t.id === id);
            if (!task) return;
            document.getElementById('editTaskId').value = id;
            document.getElementById('editTaskName').value = task.name;
            document.getElementById('editTaskDuration').value = task.duration;
            document.getElementById('editTaskBuffer').value = task.buffer || 0;
            document.getElementById('editTaskBlocking').checked = task.blocking;
            document.getElementById('editTaskNotes').value = task.notes || '';
            document.getElementById('editModal').classList.add('active');
        }
        function saveTaskEdit() {
            const id = parseInt(document.getElementById('editTaskId').value);
            const task = project.tasks.find(t => t.id === id);
            if (!task) return;
            task.name = document.getElementById('editTaskName').value.trim();
            task.duration = parseFloat(document.getElementById('editTaskDuration').value);
            task.buffer = parseFloat(document.getElementById('editTaskBuffer').value) || 0;
            task.blocking = document.getElementById('editTaskBlocking').checked;
            task.notes = document.getElementById('editTaskNotes').value.trim();
            closeEditModal();
            recalculate();
        }
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }
        // ==========================================
        // DRAG & DROP
        // ==========================================
        
        let draggedTaskId = null;
        function handleDragStart(e, id) {
            draggedTaskId = id;
            e.target.closest('tr').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragEnd(e) {
            draggedTaskId = null;
            document.querySelectorAll('.dragging, .drag-over').forEach(el => {
                el.classList.remove('dragging', 'drag-over');
            });
        }
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const tr = e.target.closest('tr');
            if (tr) {
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                tr.classList.add('drag-over');
            }
        }
        function handleDrop(e, targetId) {
            e.preventDefault();
            if (draggedTaskId === null || draggedTaskId === targetId) return;
            const fromIndex = project.tasks.findIndex(t => t.id === draggedTaskId);
            const toIndex = project.tasks.findIndex(t => t.id === targetId);
            if (fromIndex === -1 || toIndex === -1) return;
            // D√©placer la t√¢che
            const [task] = project.tasks.splice(fromIndex, 1);
            project.tasks.splice(toIndex, 0, task);
            draggedTaskId = null;
            recalculate();
        }
        // ==========================================
        // RENDU UI
        // ==========================================
        
        function renderTasks() {
            const tbody = document.getElementById('tasksBody');
            const emptyState = document.getElementById('emptyState');
            if (project.tasks.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';
            
            tbody.innerHTML = project.tasks.map((task, index) => `
                <tr draggable="true" 
                    ondragstart="handleDragStart(event, ${task.id})"
                    ondragend="handleDragEnd(event)"
                    ondragover="handleDragOver(event)"
                    ondrop="handleDrop(event, ${task.id})">
                    <td class="no-print">
                        <span class="drag-handle" title="Glisser pour r√©ordonner">‚†ø</span>
                    </td>
                    <td>${index + 1}</td>
                    <td>
                        <div class="task-name">${escapeHtml(task.name)}</div>
                        ${task.notes ? `<small style="color: var(--gray-500);">${escapeHtml(task.notes)}</small>` : ''}
                    </td>
                    <td>${task.duration} j</td>
                    <td>${task.buffer ? `+${task.buffer} j` : '-'}</td>
                    <td>
                        <span class="task-date start">${formatDateFR(task.startDate)}</span>
                    </td>
                    <td>
                        <span class="task-date end">${formatDateFR(task.endDate)}</span>
                    </td>
                    <td>
                        ${task.blocking ? '<span class="task-badge badge-blocking">Bloquante</span>' : ''}
                        ${task.buffer ? '<span class="task-badge badge-buffer">Buffer</span>' : ''}
                    </td>
                    <td class="no-print">
                        <div class="task-actions">
                            <div class="order-buttons">
                                <button class="order-btn" onclick="moveTask(${task.id}, -1)" title="Monter" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                                <button class="order-btn" onclick="moveTask(${task.id}, 1)" title="Descendre" ${index === project.tasks.length - 1 ? 'disabled' : ''}>‚ñº</button>
                            </div>
                            <button class="btn btn-sm btn-secondary btn-icon" onclick="editTask(${task.id})" title="Modifier">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger btn-icon" onclick="deleteTask(${task.id})" title="Supprimer">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        function renderGantt() {
            const container = document.getElementById('ganttChart');
            
            if (project.tasks.length === 0 || !project.deadline) {
                container.innerHTML = '<div class="empty-state"><p>Ajoutez des t√¢ches et une deadline pour voir le diagramme de Gantt</p></div>';
                return;
            }
            // Trouver les dates min et max
            let minDate = project.tasks[0]?.startDate;
            let maxDate = createDate(project.deadline);
            project.tasks.forEach(task => {
                if (task.startDate && task.startDate < minDate) minDate = task.startDate;
                if (task.endDate && task.endDate > maxDate) maxDate = task.endDate;
            });
            if (!minDate || !maxDate) {
                container.innerHTML = '<div class="empty-state"><p>Impossible de calculer les dates</p></div>';
                return;
            }
            // G√©n√©rer les jours
            const days = [];
            const currentDate = new Date(minDate);
            const today = new Date();
            today.setHours(12, 0, 0, 0);
            while (currentDate <= maxDate) {
                days.push({
                    date: new Date(currentDate),
                    isWeekend: isWeekend(currentDate),
                    isToday: formatDateISO(currentDate) === formatDateISO(today)
                });
                currentDate.setDate(currentDate.getDate() + 1);
            }
            const dayWidth = 40;
            const totalWidth = days.length * dayWidth;
            // En-t√™te du Gantt
            let html = `
                <div class="gantt-header">
                    <div class="gantt-label-col">T√¢che</div>
                    <div class="gantt-timeline" style="min-width: ${totalWidth}px;">
                        ${days.map(d => `
                            <div class="gantt-day ${d.isWeekend && project.workdaysOnly ? 'weekend' : ''} ${d.isToday ? 'today' : ''}">
                                ${d.date.getDate()}<br>${d.date.toLocaleDateString('fr-FR', {month: 'short'})}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            // Lignes des t√¢ches
            project.tasks.forEach(task => {
                if (!task.startDate || !task.endDate) return;
                const startOffset = daysBetween(minDate, task.startDate);
                const duration = daysBetween(task.startDate, task.endDate) + 1;
                const left = startOffset * dayWidth;
                const width = duration * dayWidth - 4;
                html += `
                    <div class="gantt-row">
                        <div class="gantt-row-label" title="${escapeHtml(task.name)}">${escapeHtml(task.name)}</div>
                        <div class="gantt-row-bars" style="min-width: ${totalWidth}px;">
                            ${days.map((d, i) => `
                                <div class="gantt-grid-col ${d.isWeekend && project.workdaysOnly ? 'weekend' : ''}" 
                                     style="left: ${i * dayWidth}px;"></div>
                            `).join('')}
                            <div class="gantt-bar ${task.buffer ? 'has-buffer' : ''}" 
                                 style="left: ${left}px; width: ${width}px;"
                                 title="${task.name}: ${formatDateFR(task.startDate)} ‚Üí ${formatDateFR(task.endDate)}">
                                ${duration > 2 ? task.duration + 'j' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        // ==========================================
        // STOCKAGE (localStorage)
        // ==========================================
        
        function saveProject() {
            project.name = document.getElementById('projectName').value || 'Mon Projet';
            project.deadline = document.getElementById('deadline').value;
            project.hoursPerDay = parseInt(document.getElementById('hoursPerDay').value) || 8;
            
            localStorage.setItem('retroplanning_project', JSON.stringify(project));
        }
        function loadProject() {
            const saved = localStorage.getItem('retroplanning_project');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    project = data;
                    
                    // Reconvertir les dates
                    project.tasks.forEach(task => {
                        if (task.startDate) task.startDate = new Date(task.startDate);
                        if (task.endDate) task.endDate = new Date(task.endDate);
                    });
                } catch (e) {
                    console.error('Erreur de chargement:', e);
                    loadDefaultProject();
                }
            } else {
                loadDefaultProject();
            }
            // Mettre √† jour l'UI
            document.getElementById('projectName').value = project.name;
            document.getElementById('deadline').value = project.deadline;
            document.getElementById('hoursPerDay').value = project.hoursPerDay;
            
            if (project.workdaysOnly) {
                document.getElementById('workdaysToggle').classList.add('active');
                document.getElementById('workdaysLabel').textContent = 'Oui';
            }
        }
        function loadDefaultProject() {
            
        }
        // ==========================================
        // ACTIONS UI
        // ==========================================
        
        function toggleWorkdays() {
            project.workdaysOnly = !project.workdaysOnly;
            const toggle = document.getElementById('workdaysToggle');
            const label = document.getElementById('workdaysLabel');
            
            if (project.workdaysOnly) {
                toggle.classList.add('active');
                label.textContent = 'Oui';
            } else {
                toggle.classList.remove('active');
                label.textContent = 'Non';
            }
            
            saveProject();
            recalculate();
        }
        function confirmReset() {
            document.getElementById('confirmModal').classList.add('active');
        }
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }
        function resetProject() {
            localStorage.removeItem('retroplanning_project');
            loadDefaultProject();
            document.getElementById('projectName').value = project.name;
            document.getElementById('deadline').value = project.deadline;
            document.getElementById('hoursPerDay').value = project.hoursPerDay;
            
            if (project.workdaysOnly) {
                document.getElementById('workdaysToggle').classList.add('active');
                document.getElementById('workdaysLabel').textContent = 'Oui';
            } else {
                document.getElementById('workdaysToggle').classList.remove('active');
                document.getElementById('workdaysLabel').textContent = 'Non';
            }
            
            closeModal();
            recalculate();
        }
        function printPlanning() {
            // Mettre √† jour les infos d'impression
            document.getElementById('printProjectName').textContent = project.name;
            document.getElementById('printDeadline').textContent = formatDateFR(createDate(project.deadline));
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            window.print();
        }
        // ==========================================
        // UTILITAIRES
        // ==========================================
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        // ==========================================
        // INITIALISATION
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            loadProject();
            recalculate();
            
            // Permettre Entr√©e pour ajouter une t√¢che
            document.getElementById('taskName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
        });
        // Fermer les modals avec Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeEditModal();
            }
        });
        // Fermer les modals en cliquant √† l'ext√©rieur
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeModal();
                    closeEditModal();
                }
            });
        });
    </script>
<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
</body>
</html>
